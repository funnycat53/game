<!DOCTYPE html>
<html>
 <head>
  <title> Video spēlīte </title>
 </head>

<body>
<canvas id="myCanvas" width=900 height=700 style="top: 50%; left: 50%; transform: translate(-50%, -50%); position: fixed; border: 1px solid; background:url(http://localhost:8000/images/canvas.png) "></canvas>
<script>

var ctx = myCanvas.getContext("2d"); // Get the drawing context for the canvas
 var FPS = 40;                        // How many frames per second
 var score = 0;                       
 var game_over = false;
 var initialVelocity = {
    bats: { x: (Math.random() * 1) + 0.5, y: (Math.random() * 1.5) + 0.5 },
    melons: { x: (Math.random() * 1) + 0.5, y: (Math.random() * 1.5) + 0.5 }
};

 function MySprite (img_url) {
        this.x = 0;
        this.y = 0; 
        this.visible= true;
        this.velocity_x = 0;
        this.velocity_y = 0;
        this.MyImg = new Image();
        this.MyImg.src = img_url;
        }

        MySprite.prototype.Do_Frame_Things = function() {
    if (this.visible) ctx.drawImage(this.MyImg, this.x, this.y);  // draw the thing
    
    // Move diagonally if both velocity_x and velocity_y are non-zero
    if (this.velocity_x !== 0 && this.velocity_y !== 0) {
        this.x += this.velocity_x;
        this.y += this.velocity_y;
    } else {
        // Otherwise, move vertically or horizontally
        if (this.velocity_x !== 0) {
            if ((this.velocity_x < 0 && this.x > 0) || (this.velocity_x > 0 && this.x + this.MyImg.width < myCanvas.width)) {
                this.x += this.velocity_x;
            }
        }
        if (this.velocity_y !== 0) {
            if ((this.velocity_y < 0 && this.y > 0) || (this.velocity_y > 0 && this.y + this.MyImg.height < myCanvas.height)) {
                this.y += this.velocity_y;
            }
        }
    }
}
    MySprite.prototype.GoRandomX = function() {
        this.x = Math.random() * (myCanvas.width - this.MyImg.width); // pick a random x-position, always fully visible
        }



 function ImagesTouching(thing1, thing2) {
          if (!thing1.visible  || !thing2.visible) return false;         
          if (thing1.x >= thing2.x + thing2.MyImg.width || thing1.x + thing1.MyImg.width <= thing2.x) return false;   
          if (thing1.y >= thing2.y + thing2.MyImg.height || thing1.y + thing1.MyImg.height <= thing2.y) return false; 
          return true;                                                                                                
          }

function MelonTouchingBug(melon, bug) {
    return (
        bug.x < melon.x + melon.MyImg.width &&
        bug.x + bug.MyImg.width > melon.x &&
        bug.y < melon.y + melon.MyImg.height &&
        bug.y + bug.MyImg.height > melon.y
    );
}


 var bug = new MySprite("http://localhost:8000/images/paw1.png");         // The bug
 var bats = [];                                                         // The bats
 var melons = [];            
 var time_remaining = 180; 
 addEventListener("keyup", MyKeyUpHandler);
 addEventListener("keydown", MyKeyDownHandler);                      // listen for keystrokes                                            


 function AddNewBat() {
    var noobat= new MySprite("http://localhost:8000/images/realpufferfish.png"); 
    if (Math.random() < 0.5) {
        noobat.velocity_y = initialVelocity.bats.y;
        noobat.velocity_x = 0; // No horizontal velocity
    } else {
        noobat.velocity_y = initialVelocity.bats.y;
        noobat.velocity_x = (Math.random() < 0.5 ? -1 : 1) * initialVelocity.bats.x;
    }
    noobat.GoRandomX();                           // position randomly
    bats.push(noobat); 
    setTimeout(AddNewBat, Math.random()*3000);    // never more than 3 secs between bats
        }

        function AddNewMelon() {
    var meloon = new MySprite("http://localhost:8000/images/realfish.png");
    if (Math.random() < 0.5) {
        meloon.velocity_y = initialVelocity.melons.y;
        meloon.velocity_x = 0;
    } else {
        meloon.velocity_y = initialVelocity.melons.y;
        meloon.velocity_x = (Math.random() < 0.5 ? -1 : 1) * initialVelocity.melons.x; 
    }
    meloon.GoRandomX();
    melons.push(meloon);
    setTimeout(AddNewMelon, Math.random() * 3000);
}


setInterval(function() {
    initialVelocity.bats.x *= 1.3; 
    initialVelocity.bats.y *= 1.3;
    initialVelocity.melons.x *= 1.3;
    initialVelocity.melons.y *= 1.3;
}, 10000);


 function restart_game() {
     score = 0;                   // no score
     game_over = false;           // not over yet
     time_remaining = 180;
     bats = [];                   // no bats
     melons = [];
     AddNewBat();                 // get the bats started
     AddNewMelon();
     bug.y = myCanvas.height - bug.MyImg.height;             // ensure bug always at bottom of canvas
     }


 function ShowScore() {
        ctx.fillStyle= "purple";
        ctx.font = "20px Arial";
        ctx.fillText("Score: " + score, 0, 20); 
        }

 function ShowTimer() {
        ctx.fillStyle = "blue";
        ctx.font = "20px Arial";
        ctx.fillText("Time: " + Math.ceil(time_remaining), 0, 40);
        }

 function ShowGameOver() {
        ctx.fillStyle= "red";
        ctx.font = "bold 50px Arial";
        ctx.textAlign="center";
        ctx.fillText("Game Over", myCanvas.width / 2, myCanvas.height / 2);  
        ctx.font = "bold 20px Arial";
        ctx.fillText("Press S to play again", myCanvas.width / 2, (myCanvas.height / 2)+50);
        ctx.textAlign="left";
        }


        function Do_a_Frame() {
    ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);   // clear the background
    ShowScore();                                            // show the score
    ShowTimer();
    bug.Do_Frame_Things();                                  // bug does what bugs do
    ctx.drawImage(bug.MyImg, bug.x, bug.y); // draw the bug on the canvas
    if (!game_over) {
        time_remaining -= 1 / FPS; // decrement time remaining
        if (time_remaining <= 0) {
            game_over = true;
        }

       for (var i = 0; i < melons.length; i++) {
            var melon = melons[i];
            melon.Do_Frame_Things();
            ctx.drawImage(melon.MyImg, melon.x, melon.y);

            if (MelonTouchingBug(melon, bug)) {
        melons.splice(i, 1);
        score += 1; // Increment score when a melon is picked up
    }
            if (melon.y + melon.MyImg.height > myCanvas.height) {
    melons.splice(i, 1);
    i--; // Adjust index after removing element
    score -= 1; // Deduct score if melon isn't caught
            }
        }

        for (var j = 0; j < bats.length; j++) {
            var bat = bats[j];
            bat.Do_Frame_Things();
            ctx.drawImage(bat.MyImg, bat.x, bat.y);


            if (bat.y + bat.MyImg.height > myCanvas.height) {
    bats.splice(j, 1);
    j--; // Adjust index after removing element
    score++; // Increment score if bat goes off the bottom
            }
        }

        for (var k = 0; k < bats.length; k++) {
            if (ImagesTouching(bug, bats[k])) {
                game_over = true; // Game over if bug touches a bat
                break; // Exit loop early since game over
            }
        }
    }
    if (game_over) ShowGameOver();
}

MySprite.prototype.Do_Frame_Things = function() {
        if ((this.velocity_x < 0) && (this.x > 0))  this.x = this.x + this.velocity_x;

        if ((this.velocity_x > 0) && (this.x + this.MyImg.width < myCanvas.width )) this.x = this.x + this.velocity_x;

        if ((this.velocity_y < 0) && (this.y > 0))  this.y = this.y + this.velocity_y;

        if ((this.velocity_y > 0) && (this.y + this.MyImg.height< myCanvas.height)) this.y = this.y + this.velocity_y;
        }       

   function MyKeyUpHandler (MyEvent) { 
   if (MyEvent.keyCode == 37) {bug.velocity_x=  0};    // not left
   if (MyEvent.keyCode == 38) {bug.velocity_y=  0};    // not up
   if (MyEvent.keyCode == 39) {bug.velocity_x=  0};    // not right
   if (MyEvent.keyCode == 40) {bug.velocity_y=  0};    // not down
   }

var quickness = 6

   function MyKeyDownHandler (MyEvent) { 
   if (MyEvent.keyCode == 37) {bug.velocity_x=  -quickness};      // left
   if (MyEvent.keyCode == 38) {bug.velocity_y=  -quickness};      // up
   if (MyEvent.keyCode == 39) {bug.velocity_x=   quickness};      // right
   if (MyEvent.keyCode == 40) {bug.velocity_y=   quickness};      // down
   if (MyEvent.keyCode == 83 && game_over) restart_game();    // S to restart 
   MyEvent.preventDefault()
   }

 setInterval(Do_a_Frame, 1000/FPS);                                  
 restart_game();                                                     
</script>
</body>
</html>